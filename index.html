<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leonardo Clone - Flux 1.1 Pro</title>
    
    <!-- Puter.js (The AI Brain) -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- Tailwind CSS (The Look) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Leonardo AI Dark Theme Colors */
        :root {
            --bg-dark: #0b0f19;
            --panel-dark: #151b2b;
            --accent: #8b5cf6;
            --text-main: #ececec;
            --text-muted: #94a3b8;
        }
        body { background-color: var(--bg-dark); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--panel-dark); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }

        /* Loader Animation */
        .loading-bar {
            height: 3px; width: 100%; background: #1e293b; position: relative; overflow: hidden;
        }
        .loading-bar::after {
            content: ''; position: absolute; left: -50%; width: 40%; height: 100%; background: var(--accent);
            animation: load 1.5s infinite linear;
        }
        @keyframes load { from { left: -50%; } to { left: 100%; } }

        /* Image Grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
    </style>
</head>
<body class="flex h-screen">

    <!-- SIDEBAR -->
    <aside class="w-80 bg-[#151b2b] flex flex-col border-r border-gray-800 z-20">
        <!-- Logo -->
        <div class="p-4 border-b border-gray-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded bg-gradient-to-r from-purple-500 to-indigo-500 flex items-center justify-center">
                <i class="fa-solid fa-dragon text-white"></i>
            </div>
            <h1 class="font-bold text-lg">SuperAI <span class="text-xs text-purple-400 font-normal">Flux.1 Pro</span></h1>
        </div>

        <!-- Controls -->
        <div class="p-4 flex-1 overflow-y-auto space-y-6">
            
            <!-- Reference Image -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Image Guidance</label>
                <div class="border-2 border-dashed border-gray-700 rounded-xl p-4 text-center transition hover:border-purple-500 relative bg-gray-900/50 group">
                    <input type="file" id="refInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" accept="image/*">
                    
                    <!-- Placeholder -->
                    <div id="refPlaceholder">
                        <i class="fa-solid fa-image text-2xl text-gray-600 mb-2 group-hover:text-purple-400 transition"></i>
                        <p class="text-xs text-gray-500">Upload Image Reference</p>
                    </div>

                    <!-- Preview -->
                    <div id="refPreviewContainer" class="hidden relative">
                        <img id="refPreview" class="w-full h-32 object-cover rounded-lg border border-gray-600">
                        <div id="uploadIndicator" class="absolute inset-0 bg-black/70 flex flex-col items-center justify-center rounded-lg">
                            <i class="fa-solid fa-circle-notch fa-spin text-purple-500 mb-1"></i>
                            <span class="text-[10px] text-white">Uploading...</span>
                        </div>
                        <div id="uploadDone" class="hidden absolute top-1 right-1 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-lg">
                            <i class="fa-solid fa-check"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dimensions -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Dimensions</label>
                <div class="grid grid-cols-3 gap-2">
                    <button onclick="selectRatio('1:1')" id="btn-1-1" class="ratio-btn bg-purple-600 text-white border border-transparent p-2 rounded-lg text-xs font-medium transition hover:bg-gray-700">1:1</button>
                    <button onclick="selectRatio('9:16')" id="btn-9-16" class="ratio-btn bg-gray-800 text-gray-400 border border-transparent p-2 rounded-lg text-xs font-medium transition hover:bg-gray-700">9:16</button>
                    <button onclick="selectRatio('16:9')" id="btn-16-9" class="ratio-btn bg-gray-800 text-gray-400 border border-transparent p-2 rounded-lg text-xs font-medium transition hover:bg-gray-700">16:9</button>
                </div>
            </div>

            <!-- Advanced Settings -->
            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Style & Contrast</label>
                <select id="styleSelect" class="w-full bg-gray-900 border border-gray-700 text-sm text-white rounded-lg p-2.5 outline-none focus:border-purple-500">
                    <option value="">No Preset</option>
                    <option value="Cinematic, dramatic lighting, 8k, highly detailed">Cinematic</option>
                    <option value="Anime, Studio Ghibli style, vibrant">Anime</option>
                    <option value="Photorealistic, 85mm lens, f/1.8, sharp focus">Photorealistic</option>
                    <option value="Cyberpunk, neon, futuristic city">Cyberpunk</option>
                    <option value="Digital Art, trending on ArtStation">Digital Art</option>
                </select>
            </div>

            <div class="space-y-2">
                <label class="text-xs font-bold text-gray-400 uppercase tracking-wider">Negative Prompt</label>
                <textarea id="negPrompt" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-xs text-white outline-none focus:border-purple-500 resize-none" rows="3" placeholder="What to avoid (e.g. ugly, blurry)"></textarea>
            </div>
        </div>

        <!-- System Logs (Debug Area) -->
        <div class="h-32 bg-black border-t border-gray-800 p-2 font-mono text-[10px] overflow-y-auto" id="consoleLog">
            <div class="text-blue-500">> System Ready.</div>
            <div class="text-yellow-500">> Waiting for user to Connect...</div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col relative bg-[#0b0f19]">
        
        <!-- Header -->
        <header class="h-16 border-b border-gray-800 flex items-center justify-between px-6 bg-[#151b2b]/80 backdrop-blur z-10">
            <h2 class="font-semibold text-gray-200">Generation Feed</h2>
            
            <div class="flex items-center gap-4">
                <!-- IMPORTANT: Manual Login Button -->
                <button id="connectBtn" onclick="connectPuter()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg text-xs font-bold transition flex items-center gap-2">
                    <i class="fa-solid fa-plug"></i> Connect / Login
                </button>
                <span id="connectionStatus" class="hidden text-green-400 text-xs font-bold"><i class="fa-solid fa-wifi"></i> Connected</span>
                
                <div class="h-6 w-px bg-gray-700"></div>
                <button onclick="clearAll()" class="text-red-400 hover:text-white text-xs transition">
                    <i class="fa-solid fa-trash"></i> Clear
                </button>
            </div>
        </header>

        <!-- Gallery Area -->
        <div id="gallery" class="flex-1 overflow-y-auto p-6 space-y-8">
            <!-- Welcome State -->
            <div id="emptyState" class="h-full flex flex-col items-center justify-center text-gray-600 opacity-50">
                <i class="fa-brands fa-space-awesome text-6xl mb-4"></i>
                <p>Connect first, then start creating.</p>
            </div>
        </div>

        <!-- Generation Bar -->
        <div class="p-6 bg-[#0b0f19] border-t border-gray-800 relative z-20">
            <!-- Progress Bar -->
            <div id="progressContainer" class="hidden absolute top-0 left-0 w-full">
                <div class="loading-bar"></div>
                <p class="text-center text-xs text-purple-400 mt-1 absolute w-full">Generating High Quality Image... <span id="timer">0.0s</span></p>
            </div>

            <div class="flex gap-3">
                <div class="flex-1 relative">
                    <textarea id="promptInput" class="w-full bg-[#151b2b] border border-gray-700 rounded-xl p-4 pr-20 text-white outline-none focus:border-purple-500 focus:ring-1 focus:ring-purple-500 resize-none shadow-lg" rows="2" placeholder="Describe your imagination..."></textarea>
                    <div class="absolute right-3 bottom-3 text-xs text-gray-500">Flux 1.1 Pro</div>
                </div>
                <button id="genBtn" onclick="generate()" disabled class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-8 rounded-xl font-bold hover:brightness-110 disabled:opacity-50 disabled:cursor-not-allowed transition shadow-lg shadow-purple-900/20">
                    Generate
                </button>
            </div>
        </div>
    </main>

    <!-- LOGIC -->
    <script>
        // CONFIGURATION
        const CLOUD_NAME = "dgpixx6j7";
        const UPLOAD_PRESET = "SuperAi interface"; 
        const MODEL_NAME = "black-forest-labs/FLUX.1.1-pro";

        // STATE
        let isConnected = false;
        let refImageUrl = null;
        let currentRatio = "1:1";
        let timerInt;

        // --- LOGGER UTILS ---
        function log(msg, type='info') {
            const consoleEl = document.getElementById('consoleLog');
            const div = document.createElement('div');
            if(type === 'error') div.className = "text-red-500 font-bold";
            else if(type === 'success') div.className = "text-green-400";
            else div.className = "text-gray-400";
            div.innerText = `> ${msg}`;
            consoleEl.appendChild(div);
            consoleEl.scrollTop = consoleEl.scrollHeight;
        }

        // --- STEP 1: CONNECT TO PUTER ---
        async function connectPuter() {
            log("Attempting to connect to Puter...", "info");
            try {
                // This forces the popup to open immediately
                await puter.auth.signIn(); 
                
                // If successful:
                isConnected = true;
                document.getElementById('connectBtn').classList.add('hidden');
                document.getElementById('connectionStatus').classList.remove('hidden');
                document.getElementById('genBtn').disabled = false;
                log("Connection Successful! You can now generate.", "success");
            } catch (err) {
                log("Connection Failed: " + err.message, "error");
                alert("Could not connect to Puter. Please disable popup blockers and try again.");
            }
        }

        // --- STEP 2: CLOUDINARY UPLOAD ---
        document.getElementById('refInput').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if(!file) return;

            // UI: Show Preview
            document.getElementById('refPlaceholder').classList.add('hidden');
            const previewContainer = document.getElementById('refPreviewContainer');
            previewContainer.classList.remove('hidden');
            const imgEl = document.getElementById('refPreview');
            imgEl.src = URL.createObjectURL(file);
            
            // UI: Show Loading
            document.getElementById('uploadIndicator').classList.remove('hidden');
            log("Uploading reference image to Cloudinary...", "info");

            const formData = new FormData();
            formData.append('file', file);
            formData.append('upload_preset', UPLOAD_PRESET);
            // We append the PID as context as requested
            formData.append('context', "PID=c4cbee40-4013-4464-8f3f-f8c9e493f368");

            try {
                const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                    method: 'POST',
                    body: formData
                });

                if(!res.ok) throw new Error("Cloudinary Error: " + res.statusText);

                const data = await res.json();
                refImageUrl = data.secure_url; // Save the URL
                
                // UI: Success
                document.getElementById('uploadIndicator').classList.add('hidden');
                document.getElementById('uploadDone').classList.remove('hidden');
                log("Reference image uploaded successfully.", "success");

            } catch (error) {
                console.error(error);
                log("Upload Failed: " + error.message, "error");
                document.getElementById('uploadIndicator').innerHTML = '<span class="text-red-500 text-xs">Failed</span>';
            }
        });

        // --- STEP 3: GENERATE ---
        async function generate() {
            if(!isConnected) {
                alert("Please click 'Connect' button first.");
                return;
            }

            const promptText = document.getElementById('promptInput').value.trim();
            if(!promptText) {
                alert("Please write a prompt.");
                return;
            }

            // Lock UI
            const btn = document.getElementById('genBtn');
            btn.disabled = true;
            btn.innerText = "Dreaming...";
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            
            // Timer
            const timerEl = document.getElementById('timer');
            let startTime = Date.now();
            timerInt = setInterval(() => {
                timerEl.innerText = ((Date.now() - startTime)/1000).toFixed(1) + "s";
            }, 100);

            try {
                log("Constructing prompt...", "info");
                
                // Build enhanced prompt
                let fullPrompt = promptText;
                const style = document.getElementById('styleSelect').value;
                const neg = document.getElementById('negPrompt').value;
                
                if(style) fullPrompt += `, ${style}`;
                if(currentRatio === '16:9') fullPrompt += ", cinematic wide shot 16:9";
                if(currentRatio === '9:16') fullPrompt += ", tall portrait 9:16";
                if(neg) fullPrompt += `. (Exclude: ${neg})`;
                
                // Add Reference Image URL to prompt (Simulating Refine)
                // Flux models via basic API often take text. We inject the URL as context.
                if(refImageUrl) {
                    fullPrompt += ` --reference_image_url "${refImageUrl}"`; 
                    log("Attaching reference image URL to prompt.", "info");
                }

                log(`Sending to AI: ${MODEL_NAME}...`, "info");
                
                // CALL PUTER
                // Note: Puter txt2img returns an Image Element (<img>)
                const imgElement = await puter.ai.txt2img(fullPrompt, {
                    model: MODEL_NAME
                });
                
                log("AI Generation complete. Processing...", "success");

                // Get source (usually blob: or base64)
                const aiSrc = imgElement.src;

                // Upload Result to Cloudinary
                log("Saving high-quality result to Cloudinary storage...", "info");
                const savedUrl = await uploadBlobToCloudinary(aiSrc);

                // Add to Gallery
                addToGallery(savedUrl, fullPrompt);
                
                // Save to LocalStorage
                saveLocal(savedUrl, fullPrompt);

                log("Process Finished.", "success");

            } catch (err) {
                console.error(err);
                log("GENERATION ERROR: " + err.message, "error");
                alert("Error: " + err.message + "\nCheck the logs on the left.");
            } finally {
                // Unlock UI
                clearInterval(timerInt);
                btn.disabled = false;
                btn.innerText = "Generate";
                document.getElementById('progressContainer').classList.add('hidden');
            }
        }

        // --- HELPER: Upload Result ---
        async function uploadBlobToCloudinary(src) {
            // Fetch the blob from the AI result
            const r = await fetch(src);
            const blob = await r.blob();

            const formData = new FormData();
            formData.append('file', blob);
            formData.append('upload_preset', UPLOAD_PRESET);
            formData.append('context', "generated=true|model=flux1.1pro");

            const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });
            
            if(!res.ok) throw new Error("Cloudinary Save Failed");
            const data = await res.json();
            return data.secure_url;
        }

        // --- UI FUNCTIONS ---
        function selectRatio(ratio) {
            currentRatio = ratio;
            // Reset buttons
            ['btn-1-1', 'btn-9-16', 'btn-16-9'].forEach(id => {
                const b = document.getElementById(id);
                b.className = "ratio-btn bg-gray-800 text-gray-400 border border-transparent p-2 rounded-lg text-xs font-medium transition hover:bg-gray-700";
            });
            // Active button
            const activeId = 'btn-' + ratio.replace(':', '-');
            const active = document.getElementById(activeId);
            active.className = "ratio-btn bg-purple-600 text-white border border-transparent p-2 rounded-lg text-xs font-medium transition hover:bg-gray-700";
        }

        function addToGallery(url, prompt) {
            const container = document.getElementById('gallery');
            const div = document.createElement('div');
            
            // Aspect Class
            let aspectClass = "aspect-square";
            if(currentRatio === '16:9') aspectClass = "aspect-[16/9]";
            if(currentRatio === '9:16') aspectClass = "aspect-[9/16]";

            div.innerHTML = `
                <div class="bg-[#151b2b] rounded-xl overflow-hidden border border-gray-800 hover:border-purple-500 transition shadow-lg group">
                    <div class="relative w-full ${aspectClass}">
                        <img src="${url}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                            <a href="${url}" download target="_blank" class="bg-white text-black w-8 h-8 rounded-full flex items-center justify-center hover:scale-110 transition"><i class="fa-solid fa-download"></i></a>
                        </div>
                    </div>
                    <div class="p-3">
                        <p class="text-xs text-gray-400 line-clamp-2" title="${prompt}">${prompt}</p>
                        <div class="mt-2 flex justify-between text-[10px] text-gray-600">
                            <span>Flux 1.1 Pro</span>
                            <span>${new Date().toLocaleTimeString()}</span>
                        </div>
                    </div>
                </div>
            `;
            
            // Insert at top
            if(container.firstChild) container.insertBefore(div, container.firstChild);
            else container.appendChild(div);
        }

        function saveLocal(url, prompt) {
            const hist = JSON.parse(localStorage.getItem('superai_v2_history') || '[]');
            hist.unshift({ url, prompt, ratio: currentRatio, date: new Date().toISOString() });
            localStorage.setItem('superai_v2_history', JSON.stringify(hist));
        }

        function loadLocal() {
            const hist = JSON.parse(localStorage.getItem('superai_v2_history') || '[]');
            if(hist.length > 0) {
                document.getElementById('emptyState').classList.add('hidden');
                hist.forEach(h => {
                    currentRatio = h.ratio || "1:1"; // temporary set for rendering correct aspect
                    addToGallery(h.url, h.prompt);
                });
                currentRatio = "1:1"; // reset default
            }
        }
        
        function clearAll() {
            if(confirm("Clear history?")) {
                localStorage.removeItem('superai_v2_history');
                location.reload();
            }
        }

        // Init
        window.onload = loadLocal;
    </script>
</body>
</html>

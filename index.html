<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flux 1.1 Pro Generator | SuperAI</title>
    
    <!-- Puter.js Library -->
    <script src="https://js.puter.com/v2/"></script>
    
    <!-- Tailwind CSS (for styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome (for icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom Config & Styles -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        leonardo: {
                            bg: '#0b0f19',
                            panel: '#151b2b',
                            accent: '#8b5cf6', // Violet
                            accentHover: '#7c3aed',
                            text: '#e2e8f0',
                            subtext: '#94a3b8'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0b0f19;
            color: #e2e8f0;
            overflow: hidden; /* Prevent body scroll, handle inside containers */
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #151b2b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #475569; 
        }

        .glass-panel {
            background: rgba(21, 27, 43, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Image Grid Aspect Ratios */
        .aspect-square { aspect-ratio: 1 / 1; }
        .aspect-portrait { aspect-ratio: 2 / 3; }
        .aspect-landscape { aspect-ratio: 16 / 9; }

        .loader-line {
            height: 3px;
            width: 100%;
            background-color: #1e293b;
            position: relative;
            overflow: hidden;
        }
        .loader-line::before {
            content: '';
            position: absolute;
            left: -50%;
            height: 3px;
            width: 40%;
            background-color: #8b5cf6;
            animation: lineAnim 1s linear infinite;
        }
        @keyframes lineAnim {
            0% { left: -40%; }
            50% { left: 20%; width: 80%; }
            100% { left: 100%; width: 100%; }
        }
    </style>
</head>
<body class="flex h-screen text-sm">

    <!-- LEFT SIDEBAR (Settings) -->
    <aside class="w-80 flex-shrink-0 flex flex-col border-r border-gray-800 bg-leonardo-panel overflow-y-auto">
        <div class="p-5 border-b border-gray-800 flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-purple-500 to-blue-500 flex items-center justify-center">
                <i class="fa-solid fa-wand-magic-sparkles text-white"></i>
            </div>
            <h1 class="font-bold text-lg tracking-wide text-white">SuperAI <span class="text-xs text-purple-400 font-normal">Flux Pro</span></h1>
        </div>

        <div class="p-5 space-y-6">
            <!-- Image Dimensions -->
            <div>
                <label class="block text-leonardo-subtext mb-2 font-medium">Image Dimensions</label>
                <div class="grid grid-cols-3 gap-2">
                    <button class="ratio-btn bg-gray-700 hover:bg-gray-600 border border-transparent focus:border-purple-500 p-2 rounded text-center transition active" data-ratio="1:1" onclick="setRatio(this, '1:1')">
                        <div class="w-4 h-4 border-2 border-gray-400 mx-auto mb-1"></div>
                        <span class="text-xs">1:1</span>
                    </button>
                    <button class="ratio-btn bg-gray-800 hover:bg-gray-700 border border-transparent focus:border-purple-500 p-2 rounded text-center transition" data-ratio="9:16" onclick="setRatio(this, '9:16')">
                        <div class="w-3 h-5 border-2 border-gray-400 mx-auto mb-1"></div>
                        <span class="text-xs">9:16</span>
                    </button>
                    <button class="ratio-btn bg-gray-800 hover:bg-gray-700 border border-transparent focus:border-purple-500 p-2 rounded text-center transition" data-ratio="16:9" onclick="setRatio(this, '16:9')">
                        <div class="w-5 h-3 border-2 border-gray-400 mx-auto mb-1"></div>
                        <span class="text-xs">16:9</span>
                    </button>
                </div>
            </div>

            <!-- Style Presets -->
            <div>
                <label class="block text-leonardo-subtext mb-2 font-medium">Esthetic / Style</label>
                <select id="stylePreset" class="w-full bg-gray-900 border border-gray-700 text-white rounded p-2 focus:outline-none focus:border-purple-500">
                    <option value="">None (Raw)</option>
                    <option value="Cinematic, highly detailed, dramatic lighting, 8k">Cinematic</option>
                    <option value="Anime style, vibrant colors, studio ghibli">Anime</option>
                    <option value="Photorealistic, canon 5d, 50mm lens">Photorealistic</option>
                    <option value="Digital Art, concept art, trending on artstation">Digital Art</option>
                    <option value="Neon Punk, cyberpunk, synthwave">Neon/Cyberpunk</option>
                    <option value="Oil painting, textured, classical style">Oil Painting</option>
                </select>
            </div>

            <!-- Contrast/Post Processing -->
            <div>
                <label class="block text-leonardo-subtext mb-2 font-medium">Contrast & Detail</label>
                <select id="contrastSetting" class="w-full bg-gray-900 border border-gray-700 text-white rounded p-2 focus:outline-none focus:border-purple-500">
                    <option value="">Normal</option>
                    <option value="High contrast, sharp focus">High Contrast</option>
                    <option value="Soft lighting, low contrast, dreamy">Low Contrast / Soft</option>
                    <option value="HDR, dramatic shadows">HDR</option>
                </select>
            </div>

            <!-- Negative Prompt -->
            <div>
                <label class="block text-leonardo-subtext mb-2 font-medium">Negative Prompt</label>
                <textarea id="negativePrompt" rows="3" class="w-full bg-gray-900 border border-gray-700 text-white rounded p-2 focus:outline-none focus:border-purple-500 text-xs" placeholder="What to exclude (e.g. blurry, deformed, ugly)"></textarea>
            </div>

            <!-- Reference Image Input -->
            <div>
                <label class="block text-leonardo-subtext mb-2 font-medium">
                    Image Guidance <span class="text-xs text-gray-500">(Refining)</span>
                </label>
                <div class="border-2 border-dashed border-gray-700 rounded-lg p-4 text-center hover:border-purple-500 transition cursor-pointer relative" id="dropZone">
                    <input type="file" id="refImageInput" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" accept="*">
                    <div id="refImagePreview" class="hidden w-full h-24 bg-cover bg-center rounded mb-2"></div>
                    <div id="refImageText">
                        <i class="fa-solid fa-cloud-arrow-up text-xl text-gray-500 mb-2"></i>
                        <p class="text-xs text-gray-400">Upload or drop image</p>
                    </div>
                </div>
                <p class="text-[10px] text-gray-500 mt-1">*Images uploaded are used for style reference.</p>
            </div>
            
            <!-- Warning/Note -->
            <div class="bg-blue-900/20 border border-blue-900/50 p-3 rounded text-xs text-blue-200">
                <i class="fa-solid fa-info-circle mr-1"></i>
                Using <strong>FLUX.1.1-pro</strong> via Puter.js. Images saved to Cloudinary.
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col bg-leonardo-bg relative">
        
        <!-- Header -->
        <header class="h-16 border-b border-gray-800 flex items-center justify-between px-6 bg-leonardo-panel/50 backdrop-blur">
            <h2 class="text-white font-medium">Generation Feed</h2>
            <div class="flex items-center gap-3">
                <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-300 transition">
                    <i class="fa-solid fa-trash mr-1"></i> Clear History
                </button>
            </div>
        </header>

        <!-- Gallery / Chat Area -->
        <div id="galleryContainer" class="flex-1 overflow-y-auto p-6 space-y-6">
            <!-- Welcome Message -->
            <div id="welcomeMsg" class="flex flex-col items-center justify-center h-full opacity-50">
                <i class="fa-brands fa-space-awesome text-6xl mb-4 text-purple-500"></i>
                <h3 class="text-xl font-bold">Start Creating</h3>
                <p class="text-gray-400">Enter a prompt below to generate high-quality images.</p>
            </div>
            <!-- Images will be injected here -->
        </div>

        <!-- Bottom Input Area -->
        <div class="p-6 bg-leonardo-bg border-t border-gray-800 relative z-20">
            <!-- Progress Bar -->
            <div id="progressBarContainer" class="hidden absolute top-0 left-0 w-full">
                <div class="loader-line"></div>
                <div class="text-center text-xs text-purple-300 mt-1 absolute w-full top-1">Generating High Quality Image (<span id="timer">0.0s</span>)...</div>
            </div>

            <div class="flex gap-4 items-end">
                <div class="flex-1 bg-gray-800/50 border border-gray-700 rounded-xl p-3 focus-within:border-purple-500 focus-within:ring-1 focus-within:ring-purple-500 transition shadow-lg">
                    <textarea id="mainPrompt" rows="2" class="w-full bg-transparent text-white placeholder-gray-500 focus:outline-none resize-none" placeholder="Describe your image in detail..."></textarea>
                </div>
                <button id="generateBtn" onclick="generateImage()" class="h-14 px-8 rounded-xl bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white font-bold shadow-lg shadow-purple-900/30 transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    Generate
                </button>
            </div>
        </div>
    </main>

    <!-- LOGIC -->
    <script>
        // CONFIGURATION
        const CLOUDINARY_CLOUD_NAME = "dgpixx6j7";
        const CLOUDINARY_PRESET = "SuperAi interface";
        const CLOUDINARY_PID = "c4cbee40-4013-4464-8f3f-f8c9e493f368"; // Using this as a folder/tag context
        const MODEL_NAME = "black-forest-labs/FLUX.1.1-pro";

        // STATE
        let currentRatio = "1:1";
        let refImageUrl = null;
        let isGenerating = false;
        let timerInterval;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            loadHistory();
            setupFileUpload();
        });

        // --- UI HELPERS ---
        function setRatio(btn, ratio) {
            document.querySelectorAll('.ratio-btn').forEach(b => {
                b.classList.remove('bg-gray-700');
                b.classList.add('bg-gray-800');
            });
            btn.classList.remove('bg-gray-800');
            btn.classList.add('bg-gray-700');
            currentRatio = ratio;
        }

        function setupFileUpload() {
            const input = document.getElementById('refImageInput');
            const preview = document.getElementById('refImagePreview');
            const text = document.getElementById('refImageText');

            input.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Show local preview immediately
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.classList.remove('hidden');
                    text.classList.add('hidden');
                };
                reader.readAsDataURL(file);

                // Upload to Cloudinary to get a URL for the AI (Simulating refinement)
                // Note: Flux 1.1 Pro via simple txt2img wrapper doesn't always take image input easily
                // We will upload it and keep the URL to associate with the prompt metadata.
                try {
                    const cldUrl = await uploadToCloudinary(file);
                    refImageUrl = cldUrl;
                    console.log("Reference image uploaded:", refImageUrl);
                } catch (err) {
                    console.error("Ref image upload failed", err);
                    alert("Failed to upload reference image.");
                }
            });
        }

        // --- CLOUDINARY UPLOAD ---
        async function uploadToCloudinary(fileOrBlob) {
            const formData = new FormData();
            formData.append('file', fileOrBlob);
            formData.append('upload_preset', CLOUDINARY_PRESET);
            formData.append('folder', 'SuperAi_interface'); 
            // We add the PID as a tag or context because public_id must be unique
            formData.append('context', `pid=${CLOUDINARY_PID}`); 

            const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Cloudinary Upload Failed');
            const data = await response.json();
            return data.secure_url;
        }

        // --- GENERATION LOGIC ---
        async function generateImage() {
            const promptInput = document.getElementById('mainPrompt');
            const style = document.getElementById('stylePreset').value;
            const contrast = document.getElementById('contrastSetting').value;
            const negative = document.getElementById('negativePrompt').value;
            const btn = document.getElementById('generateBtn');
            const progress = document.getElementById('progressBarContainer');
            const timerEl = document.getElementById('timer');

            const basePrompt = promptInput.value.trim();

            if (!basePrompt) {
                alert("Please enter a prompt");
                return;
            }

            if (isGenerating) return;
            isGenerating = true;

            // UI Loading State
            btn.disabled = true;
            btn.innerText = "Dreaming...";
            progress.classList.remove('hidden');
            document.getElementById('welcomeMsg').classList.add('hidden');

            // Timer
            let startTime = Date.now();
            timerInterval = setInterval(() => {
                let seconds = ((Date.now() - startTime) / 1000).toFixed(1);
                timerEl.innerText = `${seconds}s`;
            }, 100);

            try {
                // 1. Construct Enhanced Prompt
                // Flux follows prompts closely. We append style/contrast instructions.
                let fullPrompt = basePrompt;
                if (style) fullPrompt += `, ${style}`;
                if (contrast) fullPrompt += `, ${contrast}`;
                if (currentRatio === "16:9") fullPrompt += ", wide aspect ratio";
                if (currentRatio === "9:16") fullPrompt += ", tall portrait aspect ratio";
                
                // Note: Puter txt2img wrapper usually just takes prompt and options. 
                // Negative prompt isn't always standard in the simple wrapper, so we append to prompt as exclusion if needed,
                // or rely on the fact that modern Flux models handle negation in natural language "do not include...".
                // We will try to pass it in options if supported, otherwise append.
                
                // 2. Call Puter AI
                console.log("Sending Prompt:", fullPrompt);
                
                const imageElement = await puter.ai.txt2img(fullPrompt, { 
                    model: MODEL_NAME,
                    // Flux 1.1 Pro is inherently high quality.
                });

                // 3. Process Output
                // imageElement is an <img> tag with a src (likely base64 or internal blob)
                const imgUrl = imageElement.src;

                // 4. Convert to Blob for Cloudinary
                const res = await fetch(imgUrl);
                const blob = await res.blob();

                // 5. Upload to Cloudinary
                const savedUrl = await uploadToCloudinary(blob);

                // 6. Save Data
                const creationData = {
                    id: Date.now(),
                    prompt: basePrompt,
                    fullPrompt: fullPrompt,
                    negative: negative,
                    url: savedUrl,
                    refImage: refImageUrl,
                    date: new Date().toLocaleString(),
                    ratio: currentRatio
                };

                saveToLocal(creationData);
                addToGallery(creationData, true); // Prepend to top

                // Clear input
                // promptInput.value = ''; // Optional: keep prompt for iteration? Let's keep it.

            } catch (error) {
                console.error("Generation Error:", error);
                alert("Error generating image: " + error.message);
            } finally {
                isGenerating = false;
                btn.disabled = false;
                btn.innerText = "Generate";
                progress.classList.add('hidden');
                clearInterval(timerInterval);
            }
        }

        // --- STORAGE & GALLERY ---
        function saveToLocal(data) {
            let history = JSON.parse(localStorage.getItem('superai_history') || '[]');
            history.unshift(data); // Add to beginning
            // Limit history to 50 items to save space
            if (history.length > 50) history.pop();
            localStorage.setItem('superai_history', JSON.stringify(history));
        }

        function loadHistory() {
            let history = JSON.parse(localStorage.getItem('superai_history') || '[]');
            const container = document.getElementById('galleryContainer');
            
            if (history.length > 0) {
                document.getElementById('welcomeMsg').classList.add('hidden');
                history.forEach(item => addToGallery(item, false));
            }
        }

        function clearHistory() {
            if(confirm("Clear all chat history and local links?")) {
                localStorage.removeItem('superai_history');
                document.getElementById('galleryContainer').innerHTML = `
                <div id="welcomeMsg" class="flex flex-col items-center justify-center h-full opacity-50">
                    <i class="fa-brands fa-space-awesome text-6xl mb-4 text-purple-500"></i>
                    <h3 class="text-xl font-bold">Start Creating</h3>
                    <p class="text-gray-400">Enter a prompt below to generate high-quality images.</p>
                </div>`;
            }
        }

        function addToGallery(item, prepend) {
            const container = document.getElementById('galleryContainer');
            
            const div = document.createElement('div');
            div.className = "flex gap-4 p-4 rounded-xl bg-gray-800/40 border border-gray-700 animate-fade-in";
            
            // Calculate Aspect Ratio Class
            let aspectClass = "aspect-square";
            if (item.ratio === "16:9") aspectClass = "aspect-landscape";
            if (item.ratio === "9:16") aspectClass = "aspect-portrait";

            div.innerHTML = `
                <div class="flex-shrink-0 flex flex-col items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-purple-600 flex items-center justify-center text-xs font-bold text-white">AI</div>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex justify-between items-start mb-2">
                        <p class="text-white font-medium text-sm line-clamp-2" title="${item.prompt}">${item.prompt}</p>
                        <span class="text-xs text-gray-500 whitespace-nowrap ml-2">${item.date.split(',')[1]}</span>
                    </div>
                    
                    <div class="relative group rounded-lg overflow-hidden bg-black max-w-lg ${aspectClass} border border-gray-700 shadow-2xl">
                        <img src="${item.url}" class="w-full h-full object-cover" alt="Generated Image">
                        
                        <!-- Ref Image Indicator -->
                        ${item.refImage ? `<div class="absolute top-2 left-2 bg-black/50 backdrop-blur px-2 py-1 rounded text-[10px] border border-white/10"><i class="fa-solid fa-link"></i> Ref Used</div>` : ''}

                        <!-- Hover Overlay -->
                        <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3">
                            <a href="${item.url}